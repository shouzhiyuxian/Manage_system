name: Basic Dockerhub CI
on:
  # 自动触发：当推送到V1.0分支时
  push:
    branches:
      - 'V1.0'
    paths:
      - 'base-images/debian-vnc/docker/**'
      - '.github/workflows/build_base_images_debian.yml'
  
  # 手动触发：可以在GitHub Actions页面手动运行
  workflow_dispatch:
    inputs:
      docker_tag:
        description: 'Docker标签'
        required: false
        default: 'base-image-latest'
        type: string
      push_to_dockerhub:
        description: '是否推送到DockerHub'
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set image tag
        id: set-tag
        run: |
          TAG="${{ inputs.docker_tag }}"
          if [ -z "$TAG" ]; then
            TAG="base-image-latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "push=${{ inputs.push_to_dockerhub }}" >> $GITHUB_OUTPUT
      
      - name: Login to DockerHub
        if: steps.set-tag.outputs.push == 'true' || steps.set-tag.outputs.push == ''
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: base-images/debian-vnc/docker
          file: base-images/debian-vnc/docker/Dockerfile
          push: ${{ steps.set-tag.outputs.push == 'true' || steps.set-tag.outputs.push == '' }}
          tags: shouzhiyuxian/jumpserver-vapp-wayland:${{ steps.set-tag.outputs.tag }}
      
      - name: Build summary
        if: always()
        run: |
          echo "================================================"
          echo "构建完成！"
          echo "Docker镜像标签: ${{ steps.set-tag.outputs.tag }}"
          echo "推送到DockerHub: ${{ steps.set-tag.outputs.push == 'true' || steps.set-tag.outputs.push == '' }}"
          echo "================================================"
      

          