name: Basic Dockerhub CI
on:
  # è‡ªåŠ¨è§¦å‘ï¼šå½“æ¨é€åˆ°V1.0åˆ†æ”¯æ—¶
  push:
    branches:
      - 'V1.0'
    paths:
      - 'base-images/debian-vnc/docker/**'
      - '.github/workflows/build_base_images_debian.yml'
  
  # æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      docker_tag:
        description: 'Dockeræ ‡ç­¾'
        required: false
        default: 'base-image-latest'
        type: string
      push_to_dockerhub:
        description: 'æ˜¯å¦æ¨é€åˆ°DockerHub'
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set image tag and push flag
        id: config
        run: |
          TAG="${{ inputs.docker_tag }}"
          if [ -z "$TAG" ]; then
            TAG="base-image-latest"
          fi
          PUSH="${{ inputs.push_to_dockerhub }}"
          if [ -z "$PUSH" ]; then
            PUSH="true"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "push=${PUSH}" >> $GITHUB_OUTPUT
      
      - name: Login to DockerHub
        if: steps.config.outputs.push == 'true'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: base-images/debian-vnc/docker
          file: base-images/debian-vnc/docker/Dockerfile
          push: ${{ steps.config.outputs.push == 'true' }}
          tags: shouzhiyuxian/jumpserver-vapp-wayland:${{ steps.config.outputs.tag }}
      
      - name: Build summary
        if: always()
        run: |
          echo "================================================"
          echo "âœ… æ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ Dockeré•œåƒ: shouzhiyuxian/jumpserver-vapp-wayland:${{ steps.config.outputs.tag }}"
          echo "ğŸ“¤ æ¨é€çŠ¶æ€: ${{ steps.config.outputs.push }}"
          echo "================================================"
      
      
          